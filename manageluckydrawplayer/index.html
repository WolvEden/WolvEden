<html>

<title>Manage Lucky Draw Player</title>
  
<style>  
#video-background {
  position: fixed;
  right: 0; 
  bottom: 0;
  min-width: 100%; 
  min-height: 100%;
  width: auto; 
  height: auto;
  z-index: -100;
}
	._pattern-overlay { 
		position: absolute;
		top: 0;
    right: 0; 
		  min-width: 100%; 
  min-height: 100%;
  width: auto; 
  height: auto;
		opacity: 0.3;
		bottom: 0;
		background-image: url(https://cdnjs.cloudflare.com/ajax/libs/vegas/2.3.1/overlays/06.png);
		z-index: -1;
	}
  .myBackground {
  background-color: rgba(255,255,255, 0.5);
    width: 50%;
    
  color: inherit;
  }
</style>

<body style="background-color:#FFF" class="loading" oncontextmenu="return false" onselectstart="return false" ondragstart="return false">
<body>
<center>
  
  <div class="jumbotron myBackground">
<h1>ตรวจสอบจำนวนสิทธิ์ Lucky Draw คงเหลือ</h1>

<p>กรอกหมายเลขตั๋วเพื่อทำการตรวจสอบจำนวนคงเหลือ</p>

<form>

<p id="showData"></p>
<input type="input" id="ticketValue" maxlength=7 size=7 placeholder="TPC123">
<input type="button" name="buttonluckydraw1" id="buttonluckydraw1" value="Check" onclick="s1_but()">

</form>
<br></br>    
  
</div>
  <div class="jumbotron myBackground">
  <h1>เพิ่มข้อมูลผู้มีสิทธิ์ Lucky Draw</h1>
    <p>กรอกข้อมูลเพื่อเพิ่มสมาชิกใหม่</p>
    
    <form>

<p id="showData2"></p>
<p style="display:inline">Ticket Number : TPC<p style="display:inline" id="tpcID"></p> </p>
<p id="showData2"></p>
<p>Name* : <input type="input" id="nameAdd"></p>
<p>Lucky Draw : <input type="number" min="0" id="luckyDrawAdd" maxlength=3 size=3 value=0></p>      
<input type="button" name="buttonluckydraw2" id="buttonluckydraw2" value="OK"  onclick="s2_but()">
</form>
<br></br>     
    </div>
  <div class="jumbotron myBackground">
   <h1>อัพเดทสิทธิ์ Lucky Draw</h1>
    <p>กรอกหมายเลขตั๋วและใส่จำนวน Lucky Draw ที่ต้องการแก้ไข</p>
    <p id="showData3"></p>
  <form>

<p id="showData3"></p>
<p>Ticket ID : <input type="input" id="ticketID" maxlength=7 size=7 placeholder="TPC123"></p>
<p>Lucky Draw : <input type="number" min="0" id="luckyDrawUpdate" maxlength=3 size=3 placeholder="0"></p>   
<input type="button" name="btnUpdateLuckydraw" id="btnUpdateLuckydraw" value="Update" onclick="s3_but()">

</form>
<br></br>    
</div>  
  <video autoplay loop id="video-background" muted>

  <source src="http://wolveden.com/checkluckydraw/Smile%20Loop.mp4" type="video/mp4">
</video>
<div style=" display: flex;align-items: center;justify-content: center;height:100%;width:100%;text-align:left;">

</div>



  <div class="_pattern-overlay" ></div>
<script>
  window.onload = function() { document.body.className = ''; }
  window.ontouchmove = function() { return false; }
  window.onorientationchange = function() { document.body.scrollTop = 0; }
  
</script>


<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase-database.js"></script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCPBzJe7xj__L1WXYnd9ujtFyGJmy-Pafw",
    authDomain: "thailand-ponycon-2019.firebaseapp.com",
    databaseURL: "https://thailand-ponycon-2019.firebaseio.com",
    projectId: "thailand-ponycon-2019",
    storageBucket: "thailand-ponycon-2019.appspot.com",
    messagingSenderId: "666269465483"
  };
  firebase.initializeApp(config);
</script>

<script>


  
  document.getElementById("buttonluckydraw2").disabled = true;
  var userrootRef = firebase.database().ref();
var showData = document.getElementById("showData");
  var showData2 = document.getElementById("showData2");
  var showData3 = document.getElementById("showData3");
var ticketValue = document.getElementById("ticketValue");
  var tpcNextID;
  var nameAddValue = document.getElementById("nameAdd");
  var luckyDrawAddValue = document.getElementById("luckyDrawAdd");
	
  var ticketID = document.getElementById("ticketID");
  var luckyDrawUpdateValue = document.getElementById("luckyDrawUpdate");
  
  
var usersRef = 
firebase.database().ref('PlayerList/').orderByChild("ticketNumber");

userrootRef.child("PlayerList").on("value",function(snapCountChild){
 userrootRef.update({"playerCount":snapCountChild.numChildren()});
console.log(snapCountChild.numChildren());
});
  var playerCountRef ; 
  var diffplayerCount=43; 
  
  
  firebase.database().ref('playerCount/').on('value',function(snapCount){
    playerCountRef =  snapCount.val();
    tpcNextID = ("000" + (playerCountRef+1+ diffplayerCount).toString()).slice(-3);
    document.getElementById("tpcID").innerHTML = tpcNextID;
    document.getElementById("buttonluckydraw2").disabled = false;
    
  });//.on("value",function(snapCount){return snapCount.key;});
 

 
function writeUserData(userId, PlayerName, luckyDraw, ticket) 
  {
  var rootRef =  firebase.database().ref("PlayerList");
 // var newplayersRef = rootRef.child("PlayerList");
// var newPlayerRef = rootRef.push();
//newPlayerRef.set
 rootRef.child(userId).set({
 
  name : PlayerName,
    luckyDrawRemaining : luckyDraw,
    ticketNumber : ticket
  
  });
  
nameAddValue.value="";
luckyDrawAddValue.value="0";
  /*
    //firebase.database().ref('playerCount').
   usersRef.on((snap)=>{
    data= snap.val();
     count =Object.keys(data).length;
                       })
                       console.log(count);
  firebase.database().ref('PlayerList/' + userId).set({
    name: PlayerName,
    luckyDrawRemaining: luckyDraw,
    ticketNumber : ticket
  });*/
}
  
function s1_but() {   
    usersRef.equalTo(ticketValue.value).on('value', snap);
}
function snap(data) 
{
  console.log(playerCountRef);
    data2 = data.val();
   // key = Object.keys(data2)[0];
    var key="";
    data.forEach((child)=>key=child.key);
    console.log(data2); 
    	 
    if(key)
    {
	data3 = data2[key].luckyDrawRemaining;
    TicketName =  data2[key].name;
	  console.log(data3);  
      
    showData.innerHTML = "Name : "+TicketName+ "<br />" +" Your lucky draw remaining : " +data3; 
   }
   else
   {
    showData.innerHTML = "Your ticket number was not found in our database"
   }
}
  function s2_but() {   
    //usersRef.on('value', snap2);
     
   if(nameAddValue.value!=""){ writeUserData("0"+tpcNextID,nameAddValue.value,luckyDrawAddValue.value,"TPC"+tpcNextID);
   showData2.innerHTML = "";
   
   }
   else{
   
   showData2.innerHTML = "โปรดใส่ชื่อสมาชิกใหม่ห้ามปล่อยว่าง";
   
   }
}
	function snap2(data) 
{
    data2 = data.val();
    	  console.log(data2); 
	var level1 = ticketValue.value;
    if(data2[level1])
    {
	data3 = data2[level1].luckyDrawRemaining;
    TicketName =  data2[level1].name;
	  console.log(data3);  
    showData2.innerHTML = "Name : "+TicketName+ "<br />" +" Your lucky draw remaining : " +data3; 
   }
   else
   {
    showData2.innerHTML = "Your ticket number was not found in our database"
   }
}

function updateUserData(userId, luckyDraw, ticket) 
  {
  var rootRef =  firebase.database().ref("PlayerList");

 rootRef.child(userId).set({
 
  name : PlayerName,
    luckyDrawRemaining : luckyDraw,
    ticketNumber : ticket
  
  });
  
nameAddValue.value="";
luckyDrawAddValue.value="0";

}

function s3_but()
{
if(ticketID.value!=""){ 

   showData3.innerHTML = "";
   usersRef.equalTo(ticketID.value).on('value', snap3);
   
   }
   else{
   
   showData3.innerHTML = "โปรดใส่เลขตั๋วก่อนอัพเดทห้ามปล่อยว่าง";
   
   }
   
		
}
function snap3(data)
{
data3 = data.val();
console.log(data3); 

    var key="";
    data.forEach((child)=>key=child.key);
   	 
    if(key)
    {
    
 // console.log(data3[key]);
   // console.log(data3[key].luckyDrawRemaining);
   	data4 = data3[key].luckyDrawRemaining;
    TicketNameUpdate =  data3[key].name; userrootRef.child("PlayerList/"+key).update({"luckyDrawRemaining":luckyDrawUpdateValue.value});
    
   
    
		data4 = data3[key].luckyDrawRemaining;
   
	  console.log(data4);  
      
    showData3.innerHTML = " อัพเดทข้อมูลเรียบร้อย"+"<br />" +"Name : "+TicketNameUpdate+ "<br />" +"Lucky draw remaining : " +data4; 
    ticketID.value ="";
    luckyDrawUpdateValue.value =0;
   }
   else
   {
    showData3.innerHTML = "Your ticket number was not found in our database"
   }
}

</script>
</center>
</body>
